<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Eco Driving Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:radial-gradient(circle at top left,#0f1c2e,#1c2b44,#2a3b60);
  font-family:"Segoe UI",Arial,sans-serif;color:#fff;
  height:100vh;display:flex;flex-direction:column;overflow:hidden;
}
/* === HEADER === */
.ai-tip-box{flex:0 0 auto;background:#ffa500;color:#000;border-radius:1vh;
margin:1vh 2vw;padding:1.5vh 1vw;text-align:center;font-weight:bold;
font-size:clamp(1rem,2vw,1.6rem);box-shadow:0 0.5vh 1vh rgba(0,0,0,0.4);}
.stats-row{display:flex;justify-content:space-evenly;align-items:stretch;
flex-wrap:wrap;gap:1vh;margin:0 1vw;}
.stat-card{flex:1;min-width:120px;max-width:180px;background:rgba(28,34,48,0.95);
border-radius:1vh;padding:1vh;display:flex;flex-direction:column;justify-content:center;
align-items:center;text-align:center;border:1px solid rgba(255,255,255,0.2);
box-shadow:0 0.3vh 1vh rgba(0,0,0,0.4);}
.stat-label{font-size:0.9rem;opacity:0.8;}
.stat-value{font-size:1.3rem;font-weight:bold;margin-top:0.3rem;}
.speed-box{background:#4e79a7;}
.gear-box{background:#76b7b2;color:#000;}
.throttle-box{background:#2ca02c;color:#000;}
/* === SEARCH === */
.search-row{display:flex;align-items:center;justify-content:center;gap:1vw;margin:1vh 2vw;}
#searchInput{flex:1;max-width:70%;padding:0.8vh 1vw;font-size:1rem;border-radius:1vh;
border:none;outline:none;}
#micBtn{background:#ff4c4c;color:#fff;border:none;border-radius:1vh;padding:0.8vh 1.2vw;
font-weight:bold;cursor:pointer;box-shadow:0 0.4vh 1vh rgba(0,0,0,0.3);}
/* === MAIN === */
.main-section{flex:1;display:flex;flex-direction:column;gap:1vh;padding:0 2vw 1vh;}
.map-container,.camera{flex:1;position:relative;border-radius:1vh;overflow:hidden;
border:1px solid rgba(255,255,255,0.2);box-shadow:0 0.5vh 1vh rgba(0,0,0,0.4);}
.map{width:100%;height:100%;}
#map-toggle{position:absolute;top:1vh;right:1vh;z-index:1000;background:#ff8c00;
border:none;border-radius:1vh;padding:0.5vh 1vw;font-weight:bold;cursor:pointer;color:#000;}
.camera img{width:100%;height:100%;object-fit:cover;filter:blur(10px) brightness(0.8);
transition:filter 0.3s ease;}
.camera button{position:absolute;left:50%;transform:translateX(-50%);bottom:1vh;
padding:0.8vh 2vw;border:none;border-radius:1vh;color:#fff;font-weight:bold;cursor:pointer;}
#enable-camera{background:#28a745;}
#disable-camera{background:#dc3545;display:none;}
/* === ROUTE PANEL === */
#routePanel{position:absolute;bottom:2vh;left:2vw;width:260px;max-height:40vh;
overflow-y:auto;background:rgba(0,0,0,0.6);border-radius:1vh;padding:0.5vh;color:#fff;z-index:999;}
.route-box{margin-bottom:0.8vh;border-radius:1vh;overflow:hidden;}
.route-header{padding:0.4vh 0.6vw;font-weight:bold;display:flex;justify-content:space-between;
align-items:center;color:#fff;}
.route-content{background:rgba(255,255,255,0.1);padding:0.3vh 0.6vw;font-size:0.85rem;}
</style>
</head>
<body>
<div class="ai-tip-box" id="ai-tip">Drive smoothly</div>
<div class="stats-row">
  <div class="stat-card speed-box"><div class="stat-label">Speed</div><div class="stat-value" id="speed">0 km/h</div></div>
  <div class="stat-card gear-box"><div class="stat-label">Gear</div><div class="stat-value" id="gear">N</div></div>
  <div class="stat-card throttle-box"><div class="stat-label">Throttle</div><div class="stat-value" id="throttle">0%</div></div>
</div>
<div class="search-row">
  <input type="text" id="searchInput" placeholder="Search destination...">
  <button id="micBtn">ðŸŽ¤</button>
</div>
<div class="main-section">
  <div class="map-container">
    <div id="map" class="map"></div>
    <button id="map-toggle">Full Map</button>
    <div id="routePanel"></div>
  </div>
  <div class="camera">
    <img src="/video_feed" id="camera-feed" alt="Camera">
    <button id="enable-camera">Enable Camera</button>
    <button id="disable-camera">Disable</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
  
/* ==== MAP & ICONS ==== */
const map=L.map('map').setView([19.076,72.8777],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'}).addTo(map);
const carIcon=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3097/3097144.png',iconSize:[42,42]});
let userMarker=null,waypoints=[],routes=[],totalFuel=0;
const colors=['#FF6B6B','#4DA6FF','#FFD93D','#6BCB77','#FF8C00','#9B59B6','#00BFA5'];

/* ==== ECO ADVISOR ==== */
function ecoAdvisor(dist,elev,turnText){
  const t=(turnText||'').toLowerCase();
  let tip="Drive smoothly",speed=50,gear=3,throttle=45;
  const roadType=t.includes("highway")?"highway":t.includes("city")?"city":t.includes("roundabout")?"roundabout":"normal";
  if(t.includes("left")||t.includes("right")){speed=25;gear=2;throttle=35;tip="Slow for turn";}
  else if(elev>6){speed=30;gear=2;throttle=55;tip="Uphill â€” maintain torque";}
  else if(elev<-6){speed=55;gear=5;throttle=25;tip="Downhill â€” coast gently";}
  else if(dist>800){speed=65;gear=5;throttle=50;tip="Long straight â€” steady speed";}
  else if(dist>300){speed=55;gear=4;throttle=45;tip="Smooth cruising";}
  if(roadType==="highway"){speed=Math.min(speed,80);gear=Math.max(gear,5);tip+=" â€” highway";}
  else if(roadType==="city"){speed=Math.min(speed,50);gear=Math.min(gear,3);tip+=" â€” city";}
  else if(roadType==="roundabout"){speed=25;gear=2;tip+=" â€” roundabout";}
  if(speed>70) tip="High speed â€” reduce for fuel saving";
  if(throttle>60&&elev>3) tip="High throttle uphill â€” shift earlier";
  return {speed,gear,throttle,tip};
}

/* ===== Driver Behavior Monitoring ===== */
let driverStats={overspeed:0, harshAccel:0, totalPoints:0};
function updateDriverBehavior(currentSpeed,eco){
    driverStats.totalPoints++;
    if(currentSpeed>eco.speed+5) driverStats.overspeed++;
    
    const lastThrottle=document.getElementById("throttle").dataset.lastThrottle||0;
    const currentThrottle=eco.throttle;
    if(Math.abs(currentThrottle-lastThrottle)>25) driverStats.harshAccel++;
    document.getElementById("throttle").dataset.lastThrottle=currentThrottle;

    if(driverStats.overspeed/driverStats.totalPoints>0.3) eco.tip+=" â€” Slow down! Overspeed habit detected";
    if(driverStats.harshAccel/driverStats.totalPoints>0.2) eco.tip+=" â€” Smooth throttle for fuel saving";
}

/* ==== ELEVATION ==== */
async function getElevations(coords){
  try{
    const locs=coords.map(p=>`${p.lat},${p.lng}`).join('|');
    const r=await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${encodeURIComponent(locs)}`);
    const d=await r.json();return d.results.map(x=>x.elevation);
  }catch{return new Array(coords.length).fill(0);}
}

/* ==== AUTO RE-NUMBER ROUTES ==== */
function renumberRoutes(){
  const boxes=document.querySelectorAll('#routePanel .route-box');
  boxes.forEach((box,i)=>{
    const hdr=box.querySelector('.route-header b');
    if(hdr) hdr.textContent=`Route ${i+1}`;
  });
}
  
/* ===== Multi-Step Route Awareness ===== */
async function getUpcomingSteps(latlng, maxSteps=5){
  if(!routes.length) return [];
  const upcomingSteps=[];
  routes.forEach(r=>{
    let nearestIdx=-1, minDist=Infinity;
    r.steps.forEach((s,i)=>{
      const d=latlng.distanceTo([s.lat,s.lng]);
      if(d<minDist){ minDist=d; nearestIdx=i; }
    });
    if(nearestIdx!==-1){
      for(let j=nearestIdx; j<Math.min(r.steps.length, nearestIdx+maxSteps); j++){
        upcomingSteps.push(r.steps[j]);
      }
    }
  });
  return upcomingSteps;
}

async function adaptiveAIDashboard(latlng,heading){
    const currentSpeed = calculateGPSSpeed(latlng);
    const slopeData=await predictElevation(latlng,heading);
    const slope=slopeData.slope;

    let eco={speed:50,gear:3,throttle:45,tip:"Drive smoothly"};

    if(routes.length){
        // Predict 3â€“5 steps ahead based on route steps
        const upcomingSteps=[];
        routes.forEach(r=>{
            r.steps.forEach(s=>{ const d=latlng.distanceTo([s.lat,s.lng]); if(d<500) upcomingSteps.push(s); });
        });
        upcomingSteps.slice(0,5).forEach(step=>{
            const stepSlope=step.elev-recentElevations[0]||slope;
            const stepEco=ecoAdvisor(step.distance,stepSlope,step.text);
            eco=stepEco; // adopt last relevant step for dashboard
            if(step.element) step.element.title=`Tip: ${stepEco.tip}, Speed: ${stepEco.speed}, Gear: ${stepEco.gear}, Throttle: ${stepEco.throttle}%`;
        });
    }

    updateDriverBehavior(currentSpeed,eco);

    document.getElementById("speed").textContent = eco.speed+" km/h";
    document.getElementById("gear").textContent = eco.gear;
    document.getElementById("throttle").textContent = eco.throttle+"%";
    document.getElementById("ai-tip").textContent = eco.tip;
    totalFuel += (eco.throttle/1000);
    document.getElementById("fuel-used").textContent = totalFuel.toFixed(2)+" L";
}

/* ==== GPS SPEED ==== */
let lastLatLng=null,lastTime=null;
function calcSpeed(newLatLng){
  const now=Date.now();
  if(!lastLatLng){lastLatLng=newLatLng;lastTime=now;return 0;}
  const d=newLatLng.distanceTo(lastLatLng);
  const dt=(now-lastTime)/1000;const sp=(d/dt)*3.6;
  lastLatLng=newLatLng;lastTime=now;return sp;
}

/* ===== Predict multi-step elevation ahead ===== */
const ELEVATION_LOOKAHEAD=5, ELEVATION_STEP=10;
let recentElevations=[];
async function predictElevation(latlng,heading){
    const R=6378137, pointsAhead=[];
    for(let i=1;i<=ELEVATION_LOOKAHEAD;i++){
        const d=ELEVATION_STEP*i;
        const latRad=latlng.lat*Math.PI/180;
        const lonRad=latlng.lng*Math.PI/180;
        const newLat=latRad+(d*Math.cos(heading*Math.PI/180))/R;
        const newLng=lonRad+(d*Math.sin(heading*Math.PI/180))/(R*Math.cos(latRad));
        pointsAhead.push({lat:newLat*180/Math.PI,lng:newLng*180/Math.PI});
    }
    const elevs=await getElevations(pointsAhead);
    recentElevations=elevs;
    const smoothSlope = elevs.reduce((a,b,i,arr)=>i===0?a: a + (b-arr[i-1]),0)/(elevs.length-1);
    const throttleCurve=elevs.map((e,i)=>{ const delta=i===0?0:e-elevs[i-1]; return delta>3?60: delta<-3?25:45; });
    return {elevs, slope:smoothSlope, throttleCurve};
}

/* ==== GPS WATCH ==== */
if(navigator.geolocation){
  navigator.geolocation.watchPosition(async pos=>{
    const latlng=L.latLng(pos.coords.latitude,pos.coords.longitude);
    const spd=calcSpeed(latlng).toFixed(1);
    if(!userMarker){userMarker=L.marker(latlng,{icon:carIcon}).addTo(map);}
    else userMarker.setLatLng(latlng);
    map.setView(latlng);
    document.getElementById("speed").textContent=spd+" km/h";
    document.getElementById("ai-tip").textContent="Tracking active";
    checkOffRoute(latlng);
  },()=>console.warn("GPS unavailable"),{enableHighAccuracy:true});
}

/* ===== Off-route adaptation ===== */
async function checkOffRoute(latlng){
    if(routes.length){
        const nearestRoute=routes[0];
        let minDist=Infinity;
        nearestRoute.steps.forEach(s=>{ const d=latlng.distanceTo([s.lat,s.lng]); if(d<minDist) minDist=d; });
        if(minDist>30){
            console.log("Off-route detected â€” recalculating");
            if(waypoints.length>=1){
                const lastWaypoint=waypoints[waypoints.length-1];
                createRoute(latlng,lastWaypoint,colors[routes.length%colors.length]);
            }
        }
    }
}

/* ==== CREATE ROUTE ==== */
async function createRoute(start,end,color){
  const routeColor=color||colors[routes.length%colors.length];
  const rc=L.Routing.control({
    waypoints:[start,end],
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
    show:false,addWaypoints:false,createMarker:()=>null,
    lineOptions:{styles:[{color:routeColor,weight:5,opacity:0.9}]}
  }).addTo(map);
  const box=document.createElement('div');
  box.className='route-box';
  const header=document.createElement('div');
  header.className='route-header';
  header.style.background=routeColor;
  header.innerHTML=`<b>Route ${routes.length+1}</b>
  <button style="background:#ff4c4c;border:none;color:#fff;border-radius:50%;width:22px;height:22px;">âœ•</button>`;
  const content=document.createElement('div');content.className='route-content';
  box.appendChild(header);box.appendChild(content);
  document.getElementById('routePanel').appendChild(box);
  header.onclick=()=>content.style.display=content.style.display==='block'?'none':'block';
  header.querySelector('button').onclick=(e)=>{
    e.stopPropagation();map.removeControl(rc);box.remove();
    routes=routes.filter(r=>r.rc!==rc);renumberRoutes();
  };
  rc.on('routesfound',async e=>{
    const route=e.routes[0];const coords=route.coordinates.map(c=>({lat:c.lat,lng:c.lng}));
    const elevs=await getElevations(coords);
    route.instructions.forEach((s,i)=>{
      const eco=ecoAdvisor(s.distance,elevs[i]||0,s.text);
      const item=document.createElement('div');
      item.textContent=`${s.text} â€” Speed ${eco.speed}km/h | Gear ${eco.gear}`;
      content.appendChild(item);
    });
    routes.push({rc,steps:route.instructions.map((s,i)=>({lat:coords[i].lat,lng:coords[i].lng,text:s.text,distance:s.distance}))});
    renumberRoutes();
  });
}

/* ==== OFF ROUTE RE-CALC ==== */
async function checkOffRoute(latlng){
  if(!routes.length) return;
  const nearestRoute=routes[0];let minDist=Infinity;
  nearestRoute.steps.forEach(s=>{const d=latlng.distanceTo([s.lat,s.lng]);if(d<minDist)minDist=d;});
  if(minDist>30&&waypoints.length){
    console.log("Off-route detected â€” recalculating");
    const dest=waypoints[waypoints.length-1];
    createRoute(latlng,dest,colors[routes.length%colors.length]);
  }
}
  
/* ==== MAP CLICK ADD WAYPOINT ==== */
map.on('click',e=>{
  waypoints.push(e.latlng);
  if(waypoints.length>=2) createRoute(waypoints[waypoints.length-2],e.latlng);
});
  
/* ===== Rebuild Routes ===== */
function rebuildRoutes(){
    routes.forEach(r=>{ map.removeControl(r.rc); map.removeLayer(r.group); });
    routes=[]; document.getElementById('routePanel').innerHTML='';
    if(waypoints.length<2) return;
    for(let i=1;i<waypoints.length;i++){ createRoute(waypoints[i-1],waypoints[i],colors[(i-1)%colors.length],waypointMarkers[i-1],i); }
}


/* ==== MAP TOGGLE ==== */
let full=false;
document.getElementById("map-toggle").onclick=()=>{
  const mapContainer=document.querySelector(".map-container");
  const camera=document.querySelector(".camera");
  if(!full){
    Object.assign(mapContainer.style,{position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",zIndex:"9999"});
    camera.style.display="none";
    document.getElementById("map-toggle").innerText="Restore";
    full=true;setTimeout(()=>map.invalidateSize(),300);
  }else{
    mapContainer.removeAttribute("style");
    camera.style.display="block";
    document.getElementById("map-toggle").innerText="Full Map";
    full=false;setTimeout(()=>map.invalidateSize(),300);
  }
};

/* ==== CAMERA TOGGLE ==== */
const cam=document.getElementById("camera-feed");
document.getElementById("enable-camera").onclick=()=>{
  cam.style.filter="none";
  document.getElementById("enable-camera").style.display="none";
  document.getElementById("disable-camera").style.display="block";
};
document.getElementById("disable-camera").onclick=()=>{
  cam.style.filter="blur(10px) brightness(0.8)";
  document.getElementById("enable-camera").style.display="block";
  document.getElementById("disable-camera").style.display="none";
};

/* ==== MIC BTN ==== */
document.getElementById("micBtn").onclick=()=>alert("ðŸŽ¤ Voice search coming soon!");

/* ===== Search UI ===== */
const input=document.getElementById('searchInput'),suggestBox=document.getElementById('suggestBox');
let results=[];
input.oninput=async()=>{
  const q=input.value.trim(); if(!q) return suggestBox.style.display='none';
  const d=await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=6`).then(r=>r.json()).catch(()=>({features:[]})); results=d.features||[];
  suggestBox.innerHTML=''; results.forEach((f,i)=>{ const p=f.properties||{},name=p.name||p.city||'Unknown'; const div=document.createElement('div'); div.className='suggest-item'; div.innerHTML=`<b>${name}</b><div style="font-size:12px;color:#bbb;">${[p.city,p.state,p.country].filter(Boolean).join(', ')}</div>`; div.onclick=()=>select(i); suggestBox.appendChild(div); });
  suggestBox.style.display=results.length?'block':'none';
};
document.addEventListener('click',e=>{if(!suggestBox.contains(e.target)&&e.target!==input) suggestBox.style.display='none';});
document.getElementById('addBtn').onclick=()=>{if(results.length) select(0);};
input.addEventListener('keydown',e=>{if(e.key==='Enter'&&results.length) select(0);});
function select(i){ const f=results[i]; if(!f) return; const [lng,lat]=f.geometry.coordinates,latlng=L.latLng(lat,lng); waypoints.push(latlng); L.marker(latlng).addTo(map); suggestBox.style.display='none'; input.value=''; if(waypoints.length>=2) createRoute(waypoints[waypoints.length-2],latlng,colors[routes.length%colors.length]); }
</script>
</body>
</html>


