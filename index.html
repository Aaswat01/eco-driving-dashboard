<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI Eco Driving Dashboard â€” Unified Layout</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
<style>
html,body {
  margin:0;padding:0;height:100%;width:100%;
  background: radial-gradient(circle at top left, #0f1c2e, #1c2b44, #2a3b60);
  color:#fff;font-family:'Segoe UI',Arial,sans-serif;overflow:hidden;
}

/* ===== GRID LAYOUT ===== */
.parent {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-template-rows:repeat(8,1fr);
  gap:8px;
  width:100vw;height:100vh;
  box-sizing:border-box;
  padding:8px;
}

/* Keep color & design from your cards */
.box {
  background:rgba(28,34,48,0.95);
  border-radius:1.5vh;
  border:0.2vh solid #ffffff50;
  box-shadow:0 0.4vh 1.2vh rgba(0,0,0,0.3);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:1vh 1vw;
}

/* Assigning each div like before */
.div1{grid-column:span 4; background:#ffa500; color:#000;}
.div2{grid-column:span 2; grid-row-start:2; background:#4e79a7;}
.div3{grid-column:span 2; grid-column-start:3; grid-row-start:2; background:#76b7b2; color:#000;}
.div4{grid-column:span 2; grid-row-start:3; background:#c2c2c2; color:#000;}
.div5{grid-column:span 2; grid-column-start:3; grid-row-start:3; background:#2ca02c; color:#000;}
.div6{grid-column:span 3; grid-row-start:4; background:#283550;}
.div7{grid-column-start:4; grid-row-start:4; background:#283550;}
.div8{grid-column:span 4; grid-row:span 2; grid-row-start:5; position:relative;}
.div9{grid-column:span 4; grid-row:span 2; grid-row-start:7; position:relative;}

/* Stat text */
.stat-label {font-size:1.1vw;font-weight:bold;text-transform:uppercase;}
.stat-value {font-size:2vw;font-weight:bold;margin-top:0.5vh;}

/* Search + Mic */
#searchInput {
  width:80%;padding:8px 12px;border-radius:20px;border:none;background:#15161a;color:#eee;font-size:1rem;
}
#voiceBtn {
  background:#4DA6FF;border:none;color:white;padding:10px 14px;border-radius:50%;cursor:pointer;margin-left:10px;
}
#voiceBtn:hover{background:#007bff;}

/* Map + Camera */
#map {width:100%;height:100%;border-radius:1.2vh;}
#camera-feed {width:100%;height:100%;object-fit:cover;border-radius:1.2vh;filter:blur(12px) brightness(0.7);}
.map-button {
  position:absolute;bottom:1vh;left:50%;transform:translateX(-50%);
  padding:1vh 2vw;background:linear-gradient(135deg,#00d4ff,#007bff);
  color:#fff;font-weight:bold;border:none;border-radius:2vh;cursor:pointer;
  box-shadow:0 0.4vh 1.2vh rgba(0,0,0,0.5);
}
.map-button:hover{transform:translateX(-50%) scale(1.05);}
.camera-button {
  position:absolute;top:1vh;left:1vh;
  padding:0.8vh 1.6vw;background:linear-gradient(135deg,#28a745,#1c7c31);
  color:#fff;border:none;border-radius:1vh;cursor:pointer;font-weight:bold;
  box-shadow:0 0.4vh 1vh rgba(0,0,0,0.5);
}
</style>
</head>
<body>

<div class="parent">

  <div class="box div1">
    <div class="stat-label">AI Recommendation</div>
    <div class="stat-value" id="ai-tip">Drive smoothly</div>
  </div>

  <div class="box div2">
    <div class="stat-label">Speed</div>
    <div class="stat-value" id="speed">0 km/h</div>
  </div>

  <div class="box div3">
    <div class="stat-label">Gear</div>
    <div class="stat-value" id="gear">0</div>
  </div>

  <div class="box div4">
    <div class="stat-label">Fuel Used</div>
    <div class="stat-value" id="fuel-used">0.00 L</div>
  </div>

  <div class="box div5">
    <div class="stat-label">Throttle</div>
    <div class="stat-value" id="throttle">0%</div>
  </div>

  <div class="box div6">
    <input id="searchInput" placeholder="Search destination..."/>
  </div>

  <div class="box div7">
    <button id="voiceBtn">ðŸŽ¤</button>
  </div>

  <div class="box div8">
    <div id="map"></div>
    <button class="map-button" id="map-toggle">Full Map</button>
  </div>

  <div class="box div9">
    <img src="/video_feed" id="camera-feed" alt="Camera Feed"/>
    <button class="camera-button" id="toggleCam">Enable Camera</button>
  </div>

</div>

<!-- ROUTE PANEL -->
<div id="routePanel" style="position:absolute;top:10px;right:10px;width:300px;max-height:90%;overflow:auto;z-index:1000;background:#181920;border-radius:10px;padding:6px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
/* === MAP SETUP === */
const map = L.map('map').setView([19.076,72.8777],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'}).addTo(map);
const carIcon=L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3097/3097144.png',iconSize:[42,42]});
let userMarker=null, waypoints=[], waypointMarkers=[], routes=[], totalFuel=0;
const colors=['#FF6B6B','#4DA6FF','#FFD93D','#6BCB77','#9B59B6','#00BFA5'];

/* === ELEVATION FETCH === */
async function getElevations(coords){
  try{
    const locs=coords.map(p=>`${p.lat},${p.lng}`).join('|');
    const r=await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${encodeURIComponent(locs)}`);
    const d=await r.json();
    return d.results.map(x=>x.elevation);
  }catch{return new Array(coords.length).fill(0);}
}

/* === ECO ADVISOR === */
function ecoAdvisor(dist,elev,turnText,surface="asphalt"){
  let tip="Drive smoothly",speed=50,gear=3,throttle=45;
  const t=(turnText||"").toLowerCase();
  if(t.includes("left")||t.includes("right")){speed=25;gear=2;throttle=35;tip="Slow for turn";}
  else if(elev>5){speed=30;gear=2;throttle=55;tip="Uphill â€” more torque";}
  else if(elev<-5){speed=55;gear=5;throttle=25;tip="Downhill â€” coast";}
  else if(dist>800){speed=65;gear=5;throttle=50;tip="Long straight â€” steady speed";}
  if(surface!=="asphalt"){speed-=10;tip+=" â€” rough surface";}
  return {speed,gear,throttle,tip};
}

/* === MULTI-STEP LOOKAHEAD === */
async function analyzeRouteSteps(latlng){
  if(!routes.length) return;
  const route=routes[0]; let nearest=-1,minDist=1e9;
  route.steps.forEach((s,i)=>{const d=latlng.distanceTo([s.lat,s.lng]);if(d<minDist){minDist=d;nearest=i;}});
  const nextSteps=route.steps.slice(nearest,nearest+5);
  for(const s of nextSteps){
    const elevDiff=s.elev - (route.steps[nearest]?.elev||s.elev);
    const eco=ecoAdvisor(s.distance,elevDiff,s.text,s.surface);
    document.getElementById("speed").textContent=eco.speed+" km/h";
    document.getElementById("gear").textContent=eco.gear;
    document.getElementById("throttle").textContent=eco.throttle+"%";
    document.getElementById("ai-tip").textContent=eco.tip;
    totalFuel+=eco.throttle/1200;
    document.getElementById("fuel-used").textContent=totalFuel.toFixed(2)+" L";
  }
}

/* === ROUTE CREATION === */
async function createRoute(start,end,color){
  const routeColor=color||colors[routes.length%colors.length];
  const rc=L.Routing.control({
    waypoints:[start,end],
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
    show:false,addWaypoints:false,createMarker:()=>null,
    lineOptions:{styles:[{color:routeColor,weight:5,opacity:0.9}]}
  }).addTo(map);
  const group=L.layerGroup().addTo(map);
  const routeBox=document.createElement('div');
  routeBox.style.background="#252530";routeBox.style.marginBottom="6px";routeBox.style.padding="4px";routeBox.innerHTML=`<b style="color:${routeColor}">Route ${routes.length+1}</b>`;
  document.getElementById("routePanel").appendChild(routeBox);
  rc.on('routesfound',async e=>{
    const route=e.routes[0];
    const coords=route.coordinates.map(c=>({lat:c.lat,lng:c.lng}));
    const elevs=await getElevations(coords);
    const steps=[];
    route.instructions.forEach((s,i)=>{
      const elev=elevs[s.index]||0;
      const step={lat:coords[s.index].lat,lng:coords[s.index].lng,text:s.text,distance:s.distance,elev,surface:"asphalt"};
      steps.push(step);
    });
    routes.push({rc,steps,color:routeColor});
  });
}

/* === MAP CLICK === */
map.on('click',e=>{
  waypoints.push(e.latlng);
  const marker=L.marker(e.latlng).addTo(map);waypointMarkers.push(marker);
  if(waypoints.length>=2) createRoute(waypoints[waypoints.length-2],e.latlng,colors[routes.length%colors.length]);
});

/* === GPS === */
if(navigator.geolocation){
  navigator.geolocation.watchPosition(async pos=>{
    const latlng=L.latLng(pos.coords.latitude,pos.coords.longitude);
    if(!userMarker) userMarker=L.marker(latlng,{icon:carIcon}).addTo(map);
    else userMarker.setLatLng(latlng);
    analyzeRouteSteps(latlng);
  },()=>{}, {enableHighAccuracy:true});
}

/* === FULL MAP TOGGLE === */
let mapFull=false;
document.getElementById("map-toggle").onclick=()=>{
  const mapBox=document.querySelector(".div8");
  if(!mapFull){
    mapBox.style.position="fixed";mapBox.style.top="0";mapBox.style.left="0";
    mapBox.style.width="100vw";mapBox.style.height="100vh";mapBox.style.zIndex="3000";
    document.getElementById("map-toggle").innerText="Resize";
    mapFull=true;setTimeout(()=>map.invalidateSize(),400);
  }else{
    mapBox.style.position="";mapBox.style.width="";mapBox.style.height="";mapBox.style.zIndex="";
    document.getElementById("map-toggle").innerText="Full Map";
    mapFull=false;setTimeout(()=>map.invalidateSize(),400);
  }
};

/* === CAMERA TOGGLE === */
const cam=document.getElementById("camera-feed");
document.getElementById("toggleCam").onclick=()=>{
  if(cam.style.filter.includes("blur")){cam.style.filter="none";document.getElementById("toggleCam").innerText="Disable Camera";}
  else{cam.style.filter="blur(12px) brightness(0.7)";document.getElementById("toggleCam").innerText="Enable Camera";}
};

/* === VOICE SEARCH === */
const voiceBtn=document.getElementById("voiceBtn");
const input=document.getElementById("searchInput");
if('webkitSpeechRecognition' in window){
  const recog=new webkitSpeechRecognition();
  recog.lang='en-US';
  recog.onresult=e=>{
    input.value=e.results[0][0].transcript;
    performSearch(input.value);
  };
  voiceBtn.onclick=()=>recog.start();
}else{
  voiceBtn.disabled=true;
  voiceBtn.textContent='No Mic';
}

async function performSearch(query){
  if(!query) return;
  const res=await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=1`);
  const d=await res.json();
  if(d.features&&d.features.length){
    const [lng,lat]=d.features[0].geometry.coordinates;
    const latlng=L.latLng(lat,lng);
    waypoints.push(latlng);L.marker(latlng).addTo(map);
    if(waypoints.length>=2) createRoute(waypoints[waypoints.length-2],latlng,colors[routes.length%colors.length]);
  }
}
</script>
</body>
</html>
